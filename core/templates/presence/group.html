{% extends "index.html" %}
{% load url from future %}
{% load i18n %}

{% block content %}

<div class="row-fluid">
    <div class="span8 offset1">
        <div class="well centered">
            <h3>{{ start|date:"DATE_FORMAT" }} - {{ end|date:"DATE_FORMAT" }}</h3>
            <a class="btn btn-primary" href="{% url "core-pdf-presence-clean" group.id end.year end.month %}">
                {% trans "Print empty page for" %} {{ end|date:"F Y" }}</a>
            <a class="btn btn-info" href="{% url "core-pdf-presence" group.id end.year end.month %}">
                {% trans "Print filled page for" %} {{ end|date:"F Y" }}</a>
        </div>
    </div>
</div>

<div class="row-fluid">
    <div class="span10">
        <form class="form-inline">
            <label>{% trans "Set presence for all" %}:</label>
            <select class="span2" size="1" id="p_all_day">
                {% for d in days %}<option value="{{ d|date:"Y-m-d" }}"{% if d == today %} selected="selected"{% endif %}>{{ d|date:"d.m." }}</option>{% endfor %}
            </select>
            <select class="span1" id="p_all" size="1">
                {% for e in choices %}<option value="{{ e }}"{% if e == "*" %} selected="selected"{% endif %}>{{ e }}</option>{% endfor %}
            </select>
            <button class="btn" type="button" onclick="update_all();" title="{% trans "Sets the presence for all EMPTY fields." %}">
                {% trans "Set now" %}
            </button>
        </form>
    </div>
</div>

<div class="row-fluid">
    <div class="span10">
        <table class="dTable table table-striped table-bordered">
            <thead>
                <tr>
                    <th>{% trans "Company" %}</th>
                    <th>{% trans "Lastname" %}</th>
                    <th>{% trans "Firstname" %}</th>
                    {% for d in days %}
                    <th>{{ d|date:"D d" }}</th>
                    {% endfor %}
                    <th>{% trans "Lastname" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for s, ds in students %}
                <tr>
                    <td>{{ s.company.short_name|default:s.company.name }}</td>
                    <td><a href="{% url "core-presence-edit" s.id %}" class="tt" title="{% trans "Click here to enter notes." %}">{{ s.lastname }}</a></td>
                    <td>{{ s.firstname }}</td>
                    {% for d in ds %}
                    <td><select id="p_{{ d.id }}"  title="{{ d.get_entry_display }}" class="{{ d.date|date:"Y-m-d" }} input-mini" name="presence" size="1" onchange="update_day({{ d.id }});">
                            {% for e in choices %}<option value="{{ e }}"{% if e == d.entry %} selected="selected"{% endif %}>{{ e }}</option>{% endfor %}
                        </select>
                        <br>
                        <input id="l_{{ d.id }}" title="{% trans "Enter lateness here." %}" class="input-mini" type="text" size="2" maxlength="3"{% if d.lateness %} style="border:1px solid red;"{% endif %} name="lateness" value="{% if d.lateness %}{{ d.lateness }}{% endif %}" onchange="lateness_changed({{ d.id }});">
                        {% if d.note %}<a href="#" title="{{ d.note }}" class="tt">*</a>{% endif %}
                    </td>
                    {% endfor %}
                    <td>{{ s.lastname }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="row-fluid">
    <div class="span8 offset1">
        <table style="margin:5px auto;">
            <tr>
                {% for sym, txt in legend %}
                <td>{% if forloop.first %}<small>{% trans "Legend" %}:</small>{% endif %}</td>
                <td style="width:15px;"></td>
                <td><small>{{ sym }} = {{ txt }}</small></td>
                {% cycle '' '' '' '</tr><tr>' %}
                {% endfor %}
        </table>
    </div>
</div>

<div class="row-fluid">
    <div class="span2">
        <a class="btn btn-info" href="{% url "core-presence" %}#{{ group.job }}">{% trans "Back" %}</a>
    </div>
</div>

{% endblock %}

{% block additional_js %}
<script>
$(function() {
    datatable_options['bPaginate'] = false;
    datatable_options['sScrollX'] = '100%';
    datatable_options['bScrollCollapse'] = true;
    $('.dTable').each(function() {
        var t = $(this);
        t.dataTable(datatable_options);
    });
});

function update_day(did) {
    var day_id = did;
    var lateness = $('#l_'+did).val();
    var presence = $('#p_'+did+' :selected').val();
    var json_data = {'day_id': day_id, 'lateness': parseInt(lateness),
                     'presence': presence};
    $.post('{% url "core-api-presence-update" %}',
        {'_JSON_': JSON.stringify(json_data)},
        function(ret_data) {
            show_update_container();
            add_update_message(ret_data['msg']);
            if (parseInt(lateness) > 0) {
                $('#l_'+did).css('border', '1px solid red');
            } else {
                $('#l_'+did).css('border', '');
            }
        });
}

function update_all() {
    var date = $('#p_all_day :selected').val();
    var entry = $('#p_all :selected').val();
    $('select.'+date).each(function(index) {
        if ($(this).val() == '') {
            $(this).val(entry);
            $(this).change();
        }
    });
}

function lateness_changed(did) {
    $('#p_'+did+'').val('*').attr('selected', 'selected');
    update_day(did);
}
</script>
{% endblock %}
